<div class="content">
    <sentinel-controls (itemClicked)="onControlAction($event)" [controls]="controls"/>
    <sentinel-table
        (rowAction)="onInstanceAction($event)"
        (tableLoad)="onInstancesLoadEvent($event)"
        [data]="instances$ | async"
        [defaultSortDirection]="INITIAL_SORT_DIR"
        [defaultSortName]="INITIAL_SORT_NAME"
        [displayedActionsCount]="8"
        [hasError]="hasError$ | async"
        [titlecasedActions]="false">
        <ng-container *sentinelRow="'startTime'; template: startTime"/>
        <ng-container *sentinelRow="'endTime'; template: endTime"/>
        <ng-container *sentinelRow="'expiresIn'; template: instanceCountdown"/>
        <ng-container *sentinelRow="'accessToken'; template: accessToken"/>
        <ng-container *sentinelRow="'poolSize'; template: poolSize"/>
    </sentinel-table>
</div>
<ng-template #instanceCountdown let-row>
    <crczp-table-countdown [endTime]="row.element.endTime"/>
</ng-template>
<ng-template #startTime let-row>
    <crczp-table-date-cell [displayedDate]="row.element.startTime" [showTimeWhenPossible]="true"/>
</ng-template>
<ng-template #endTime let-row>
    <crczp-table-date-cell [displayedDate]="row.element.endTime" [showTimeWhenPossible]="true"/>
</ng-template>

<ng-template #accessToken let-row>
    <div *ngIf="row.element.poolSize | async as poolSize; else loading"
         class="access-token-container"
         matTooltip="{{ getAccessTokenTooltip(poolSize[1], row.element.localEnvironment, poolSize[0]) }}"
    >
        <button
            (click)="onCopyToken()"
            [cdkCopyToClipboard]="row.element.accessToken"
            [disabled]="!row.element.localEnvironment && (poolSize[1]==='0' || poolSize[1]==='')"
            class="token-button"
            color="primary"
            mat-button
        >
            {{ row.element.accessToken }}
        </button>

        @if (!row.element.localEnvironment && poolSize[0] === '-') {
            <mat-icon color="warn">error</mat-icon>
        } @else if (!row.element.localEnvironment && poolSize[1] === '0') {
            <mat-icon class="warning">warning</mat-icon>
        }
    </div>
    <ng-template #loading>
        <crczp-logo-spinner/>
    </ng-template>
</ng-template>

<ng-template #poolSize let-row>
    <div *ngIf="row.element.poolSize | async as poolSize; else loading">
        <div *ngIf="poolSize[0] !== '-' else errorState">
            <span>{{ poolSize[0] }}</span>
            <span *ngIf="poolSize[1]"
            > (<span [ngClass]="{ 'warn': poolSize[1] === 0 }">{{ poolSize[1] }}  free</span>)</span
            >
        </div>
        <div *ngIf="row.element.poolTitle === 'Local'">
            <span>{{ poolSize[0] }}</span>
        </div>
        <ng-template #errorState>
            <mat-icon *ngIf="row.element.poolTitle !== 'Local'" [matTooltip]="'Given pool does not exist.'"
                      class="warn">warning
            </mat-icon>
        </ng-template>
    </div>
    <ng-template #loading>
        <mat-progress-spinner [diameter]="20" color="accent" mode="indeterminate"/>
    </ng-template>
</ng-template>
