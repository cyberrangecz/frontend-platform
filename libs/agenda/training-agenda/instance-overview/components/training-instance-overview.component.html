<div class="content">
    <sentinel-controls [controls]="controls" />
    <sentinel-table
        (tableLoad)="onInstancesLoadEvent($event)"
        [data]="instances$ | async"
        [defaultSortDirection]="INITIAL_SORT_DIR"
        [defaultSortName]="INITIAL_SORT_NAME"
        [displayedActionsCount]="9"
        [hasError]="hasError$ | async"
        [titlecasedActions]="false">
        <ng-container *sentinelRow="'startTime'; template: startTime" />
        <ng-container *sentinelRow="'endTime'; template: endTime" />
        <ng-container *sentinelRow="'expiresIn'; template: instanceCountdown" />
        <ng-container *sentinelRow="'accessToken'; template: accessToken" />
        <ng-container *sentinelRow="'poolSize'; template: poolSize" />
    </sentinel-table>
</div>

<ng-template #instanceCountdown let-row>
    <crczp-table-countdown [endTime]="row.element.endTime" />
</ng-template>
<ng-template #startTime let-row>
    <crczp-table-date-cell [displayedDate]="row.element.startTime" [showTimeWhenPossible]="true" />
</ng-template>
<ng-template #endTime let-row>
    <crczp-table-date-cell [displayedDate]="row.element.endTime" [showTimeWhenPossible]="true" />
</ng-template>

<ng-template #accessToken let-row>
    @if (castToPoolSize(row.element.poolSize | async); as poolSize) {
        <div
            class="access-token-container"
            matTooltip="{{ getAccessTokenTooltip(poolSize, row.element.localEnvironment) }}"
        >
            <button
                (click)="onCopyToken()"
                [cdkCopyToClipboard]="row.element.accessToken"
                [disabled]="tokenCopyDisabled(poolSize, row.element.localEnvironment)"
                class="token-button"
                color="primary"
                mat-button
            >
                {{ row.element.accessToken }}
            </button>
            @if (!row.element.localEnvironment && 'error' in poolSize) {
                <mat-icon color="warn">error</mat-icon>
            } @else if (!row.element.localEnvironment && getFreePoolSize(poolSize) <= 0) {
                <mat-icon class="warning">warning</mat-icon>
            }
        </div>
    } @else {
        <mat-progress-spinner diameter="20" mode="indeterminate" />
    }
</ng-template>

<ng-template #poolSize let-row>
    @if (castToPoolSize(row.element.poolSize | async); as poolSize) {
        <div>
            @if ('error' in poolSize) {
                @if (row.element.poolTitle !== 'Local') {
                    <mat-icon [matTooltip]="'Given pool does not exist.'"
                              class="warn">warning
                    </mat-icon>
                }
            } @else {
                <div>
                    <span>{{poolSize.total}} ({{poolSize.total - poolSize.used}} free)</span>
                </div>
            }
            @if (row.element.poolTitle === 'Local') {
                <div>
                    <span>N/A</span>
                </div>
            }
        </div>
    } @else {
        <mat-progress-spinner diameter="20" mode="indeterminate" />
    }
</ng-template>
