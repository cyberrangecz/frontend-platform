<form [formGroup]="extendedMatchingQuestionFormGroup.formGroup" class="emi-edit">
    <div class="emi-edit__content">
        <div class="emi-edit__form-container">
            <!-- TITLE field-->
            <h3>Title</h3>
            <div class="emi-edit__question-text">
                <sentinel-markdown-editor
                    (contentChange)="title.setValue($event)"
                    [content]="title.value"
                    [sentinel-markdown-file-upload]="false"
                />
                @if (title.hasError('whitespace')) {
                    <mat-error>Title cannot be empty</mat-error>
                }
            </div>

            <!--SCORE field -->
            @if (isTest) {
                <div class="emi-edit__inline-input">
                    <mat-form-field appearance="outline" hintLabel="Number in range from 0
          to {{ maxQuestionScore }}">
                        <mat-label>Points</mat-label>
                        <input matInput placeholder="Points" type="number"
                               [max]="maxQuestionScore" min="0" formControlName="score"
                               [required]="required">
                        @if (score.hasError('required')) {
                            <mat-error>Question score cannot be
                                empty
                            </mat-error>
                        }
                        @if (score.hasError('pattern') || score.hasError('min')
                        || score.hasError('max')) {
                            <mat-error>Question score must be a number in range
                                from 0 to {{ this.maxQuestionScore }}
                            </mat-error>
                        }
                    </mat-form-field>
                    <!--PENALTY field -->
                    <mat-form-field appearance="outline" hintLabel="Number in range from 0
          to {{ maxQuestionPenalty }}">
                        <mat-label>Penalty points</mat-label>
                        <input matInput placeholder="Question Penalty points" type="number"
                               [max]="maxQuestionPenalty" min="0" formControlName="penalty"
                               [required]="required">
                        @if (penalty.hasError('required')) {
                            <mat-error>Question penalty
                                cannot be empty
                            </mat-error>
                        }
                        @if (penalty.hasError('pattern') ||
                        penalty.hasError('min') || penalty.hasError('max')) {
                            <mat-error>Question penalty
                                must be a number in range from 0 to this.{{ maxQuestionPenalty }}
                            </mat-error>
                        }
                    </mat-form-field>
                </div>
            }
        </div>


        <!-- EMI -->
        <div class="emi-edit__answers">
            <table>
                <!-- DELETE OPTION BUTTONS -->
                <tr class="emi-edit__row emi-edit__row--first">
                    <td class="emi-edit__cell"></td>
                    @for (option of options.controls; track option; let i = $index) {
                        <td class="emi-edit__cell">
                            <button matSuffix mat-icon-button aria-label="Delete
              option" color="warn" matTooltip="Delete option"
                                    (click)="deleteOption(i)">
                                <mat-icon>remove_circle</mat-icon>
                            </button>
                        </td>
                    }
                </tr>
                <!-- OPTION HEADER -->
                <tr class="emi-edit__row">
                    <td class="emi-edit__cell">
                        @if (isTest) {
                            <button [disabled]="!isCheckedAnyOption()"
                                    mat-flat-button color="warn" (click)="clearAnswers()" class="emi-edit__clear-button">Clear
                                Answers
                            </button>
                        }
                    </td>

                    @for (option of options.controls; track trackByFn(i); let i = $index) {
                        <td formArrayName="options" class="emi-edit__cell">
                            <!-- OPTION NAME -->
                            <div [formGroupName]="i">
                                <mat-form-field class="emi-edit__option-field"
                                                (keydown.enter)="$event.preventDefault()">
                                    <mat-label>Option {{ i + 1 }}</mat-label>
                                    <input matInput placeholder="Option {{ i + 1 }}"
                                           [formControl]="$any(option.get('text'))" required>
                                </mat-form-field>
                            </div>
                        </td>
                    }

                    <!-- ADD OPTION BUTTON -->
                    <td class="emi-edit__cell emi-edit__cell--last">
                        @if (!columnLimitReached) {
                            <button matSuffix mat-icon-button aria-label="Add option"
                                    color="primary" matTooltip="Add option"
                                    (click)="addOption()">
                                <mat-icon>add_circle</mat-icon>
                            </button>
                        }
                    </td>
                </tr>
                <!-- STATEMENTS WITH RADIO BUTTONS -->
                @for (statement of statements.controls; track trackByFn(i); let i = $index) {
                    <tr formArrayName="statements" class="emi-edit__row">
                        <td class="emi-edit__cell" [formGroupName]="i">
                            <!-- STATEMENT NAME -->
                            <mat-form-field
                                class="emi-edit__statement-field"
                                            (keydown.enter)="$event.preventDefault()">
                                <mat-label>Statement {{ i + 1 }}</mat-label>
                                <input matInput placeholder="Statement {{ i + 1 }}"
                                       [formControl]="$any(statement.get('text'))"
                                       required>
                            </mat-form-field>
                        </td>
                        <!-- STATEMENT OPTIONS -->
                        <mat-radio-group>
                            @for (option of getOptions(); track option; let j = $index) {
                                <td class="emi-edit__cell">
                                    <mat-radio-button [disabled]="!isTest || !required"
                                                      [value]="{ x: i, y: j }"
                                                      [checked]="isOptionChecked(statement, j)"
                                                      (change)="onCorrectOptionChanged(i, j)"/>
                                </td>
                            }
                        </mat-radio-group>
                        <!-- DELETE STATEMENT BUTTON -->
                        <td class="emi-edit__cell emi-edit__cell--last">
                            <button matSuffix mat-icon-button aria-label="Delete statement"
                                    color="warn" matTooltip="Delete statement"
                                    (click)="deleteStatement(i)">
                                <mat-icon>remove_circle</mat-icon>
                            </button>
                        </td>
                    </tr>
                }
                <!-- ADD STATEMENT BUTTON -->
                <tr class="emi-edit__row emi-edit__row--last">
                    <td class="emi-edit__cell emi-edit__cell--add-statement">
                        <button (click)="addStatement()" aria-label="Add new
              statement" color="primary" mat-icon-button matSuffix
                                matTooltip="Add new statement">
                            <mat-icon>add_circle</mat-icon>
                        </button>
                    </td>
                </tr>
            </table>
        </div>

        @if (isTest &&
        extendedMatchingQuestionFormGroup.formGroup.hasError('noSelectedAnswers')) {
            <mat-error>Test
                question must have selected correct answers
            </mat-error>
        }
        @if (options.hasError('whitespace')) {
            <mat-error>Options cannot be empty</mat-error>
        }
        @if (statements.hasError('whitespace')) {
            <mat-error>Statements cannot be empty</mat-error>
        }
    </div>
</form>
