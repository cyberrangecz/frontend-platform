<form [formGroup]="extendedMatchingQuestionFormGroup.formGroup">
    <div class="content">
        <div class="form-container">
            <!-- TITLE field-->
            <h3>Title</h3>
            <div class='question-text'>
                <sentinel-markdown-editor
                    (contentChange)="title.setValue($event)"
                    [content]="title.value"
                    [sentinel-markdown-file-upload]="false"
                />
                @if (title.hasError('whitespace')) {
                    <mat-error>Title cannot be empty</mat-error>
                }
            </div>

            <!--SCORE field -->
            @if (isTest) {
                <div class="inline-input">
                    <mat-form-field appearance="outline" hintLabel="Number in range from 0
          to {{ maxQuestionScore }}">
                        <mat-label>Points</mat-label>
                        <input matInput placeholder="Points" type="number"
                               [max]="maxQuestionScore" min="0" formControlName="score"
                               [required]="required">
                        @if (score.hasError('required')) {
                            <mat-error>Question score cannot be
                                empty
                            </mat-error>
                        }
                        @if (score.hasError('pattern') || score.hasError('min')
                        || score.hasError('max')) {
                            <mat-error>Question score must be a number in range
                                from 0 to {{ this.maxQuestionScore }}
                            </mat-error>
                        }
                    </mat-form-field>
                    <!--PENALTY field -->
                    <mat-form-field appearance="outline" hintLabel="Number in range from 0
          to {{ maxQuestionPenalty }}">
                        <mat-label>Penalty points</mat-label>
                        <input matInput placeholder="Question Penalty points" type="number"
                               [max]="maxQuestionPenalty" min="0" formControlName="penalty"
                               [required]="required">
                        @if (penalty.hasError('required')) {
                            <mat-error>Question penalty
                                cannot be empty
                            </mat-error>
                        }
                        @if (penalty.hasError('pattern') ||
                        penalty.hasError('min') || penalty.hasError('max')) {
                            <mat-error>Question penalty
                                must be a number in range from 0 to this.{{ maxQuestionPenalty }}
                            </mat-error>
                        }
                    </mat-form-field>
                </div>
            }
        </div>

        @if (isTest) {
            <button [disabled]="!isCheckedAnyOption()"
                    mat-button color="warn" (click)="clearAnswers()" class="clear-answers">Clear
                Answers
            </button>
        }
        <!-- EMI -->
        <div class="emi-answers">
            <table>
                <!-- DELETE OPTION BUTTONS -->
                <tr class="first-statement">
                    <td></td>
                    @for (option of options.controls; track option; let i = $index) {
                        <td
                            class="delete-col-buttons">
                            <button matSuffix mat-icon-button aria-label="Delete
              option" color="warn" matTooltip="Delete option"
                                    (click)="deleteOption(i)">
                                <mat-icon>remove_circle</mat-icon>
                            </button>
                        </td>
                    }
                </tr>
                <!-- OPTION HEADER -->
                <tr class="inner">
                    <td></td>

                    @for (option of options.controls; track trackByFn(i); let i = $index) {
                        <td formArrayName="options" class="col-header">
                            <!-- OPTION NAME -->
                            <div [formGroupName]="i">
                                <mat-form-field class="option-field"
                                                (keydown.enter)="$event.preventDefault()">
                                    <mat-label>Option {{ i + 1 }}</mat-label>
                                    <input matInput placeholder="Option {{ i + 1 }}"
                                           [formControl]="$any(option.get('text'))" required>
                                    @if (option.get('text').value) {
                                        <button matSuffix mat-icon-button
                                                aria-label="Clear" (click)="option.get('text').setValue('')">
                                            <mat-icon>close</mat-icon>
                                        </button>
                                    }
                                </mat-form-field>
                            </div>
                        </td>
                    }

                    <!-- ADD OPTION BUTTON -->
                    <td class="last-option">
                        @if (!columnLimitReached) {
                            <button matSuffix mat-icon-button aria-label="Add option"
                                    color="primary" matTooltip="Add option"
                                    (click)="addOption()">
                                <mat-icon>add_circle</mat-icon>
                            </button>
                        }
                    </td>
                </tr>
                <!-- STATEMENTS WITH RADIO BUTTONS -->
                @for (statement of statements.controls; track trackByFn(i); let i = $index) {
                    <tr formArrayName="statements" class="inner">
                        <td [formGroupName]="i">
                            <!-- STATEMENT NAME -->
                            <mat-form-field class="statement-field"
                                            (keydown.enter)="$event.preventDefault()">
                                <mat-label>Statement {{ i + 1 }}</mat-label>
                                <input matInput placeholder="Statement {{ i + 1 }}"
                                       [formControl]="$any(statement.get('text'))"
                                       required>
                                @if (statement.get('text').value) {
                                    <button matSuffix mat-icon-button
                                            aria-label="Clear" (click)="statement.get('text').setValue('')">
                                        <mat-icon>close</mat-icon>
                                    </button>
                                }
                            </mat-form-field>
                        </td>
                        <!-- STATEMENT OPTIONS -->
                        <mat-radio-group>
                            @for (option of getOptions(); track option; let j = $index) {
                                <td>
                                    <mat-radio-button [disabled]="!isTest || !required"
                                                      [value]="{ x: i, y: j }"
                                                      [checked]="isOptionChecked(statement, j)"
                                                      (change)="onCorrectOptionChanged(i, j)"/>
                                </td>
                            }
                        </mat-radio-group>
                        <!-- DELETE STATEMENT BUTTON -->
                        <td class="last-option">
                            <button matSuffix mat-icon-button aria-label="Delete statement"
                                    color="warn" matTooltip="Delete statement"
                                    (click)="deleteStatement(i)">
                                <mat-icon>remove_circle</mat-icon>
                            </button>
                        </td>
                    </tr>
                }
                <!-- ADD STATEMENT BUTTON -->
                <tr class="last-statement">
                    <td>
                        <button (click)="addStatement()" aria-label="Add new
              statement" color="primary" mat-icon-button matSuffix
                                matTooltip="Add new statement">
                            <mat-icon>add_circle</mat-icon>
                        </button>
                    </td>
                </tr>
            </table>
        </div>

        @if (isTest &&
        extendedMatchingQuestionFormGroup.formGroup.hasError('noSelectedAnswers')) {
            <mat-error>Test
                question must have selected correct answers
            </mat-error>
        }
        @if (options.hasError('whitespace')) {
            <mat-error>Options cannot be empty</mat-error>
        }
        @if (statements.hasError('whitespace')) {
            <mat-error>Statements cannot be empty</mat-error>
        }
    </div>
</form>
